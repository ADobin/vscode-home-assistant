
trigger:
  branches:
    include:
    - '*'
  paths:
    include:
    - 'src/language-service/*'  
    - 'azure-pipelines-language-service.yml'  
pr:
- dev
  
stages:
- stage: build_language_service
  displayName: 'Build Language Service'
  jobs:

  - job: BuildExtension
    pool:
      vmImage: 'ubuntu-latest'
          
    steps:

    # - task: NodeTool@0
    #   inputs:
    #     versionSpec: '10.x'
    #   displayName: 'Install Node.js' 

    - script: |
        rm package-lock.json # this is weird is should not be needd
        npm install
        npm run compile
        mkdir package
        cd package
        npm pack ../
      workingDirectory: src/language-service
      displayName: 'npm install and compile' 

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: 'src/language-service/package' 
        artifact: language-service 

- stage: publish_language_service
  displayName: 'Publish Language Service'
  condition: succeeded('build_language_service')
  
  jobs:

  - deployment: publish_language_service
    displayName: Publish Language Service to NPM
    pool:
      vmImage: 'ubuntu-latest' 
    environment: Production
    strategy:
      runOnce:
        deploy:  
          steps:  

          - task: DownloadPipelineArtifact@2
            inputs:
              artifactName: language-service 
              buildType: 'current'
              targetPath: '$(Pipeline.Workspace)'
 
          - task: Npm@1
            inputs:
              command: 'custom'
              customCommand: 'publish *.tgz'
              publishEndpoint: 'npmjs.org' 
              workingDir: '$(Pipeline.Workspace)'